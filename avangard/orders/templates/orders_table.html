<div id="jsGrid"></div>

<script type="text/javascript">

    // Если изменили заказ
    $(document).ready(function() {
            setTimeout(function(){ webSocket.send('StatusChanged'); }, 1000)
    });

    //Идентификатор последней добавленной записи

    var latest_id = 0;

    //Создание вебсокета
    var webSocket = new WebSocket('ws://' + window.location.host + '/orders/');
    webSocket.onmessage = function(message) {
        if (message.data === "StatusChanged") {
            $("#jsGrid").jsGrid("render").done(function() {});
        }
    };


    //Long Poll для проверки новых заказов

    function subscribe() {
        var xhr = new XMLHttpRequest();
        var url = "/orders/check_new_orders";

        xhr.open("POST", url, true);
        xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');

        xhr.onreadystatechange = function () {
            if (xhr.readyState === XMLHttpRequest.DONE && xhr.status === 200) {

                //Проверка на новые заказы

                if (xhr.responseText === "true") {

                    //Получение новых заказов

                    $.ajax({
                        type: "GET",
                        url: "/orders/get_new_orders",
                        data: {'latest_id': latest_id}
                    }).done(function (result) {
                        $.each(result.new_orders, function (i, val) {

                            //Добавление в таблицу

                            $("#jsGrid").jsGrid("insertItem", val).done(function () {
                                console.log("insertion completed");
                            });
                            latest_id = val.pk
                        });
                    })
                }
            }
        };

        xhr.send("latest_id=" + latest_id);
    }

    function format_date(date_string) {
        var d = new Date(date_string);
        return d.getDate() + '.' + d.getMonth() + '.' + d.getFullYear();
    }

    //Стратегия добавления новых записей

    var MyCustomDirectLoadStrategy = function (grid) {
        jsGrid.loadStrategies.DirectLoadingStrategy.call(this, grid);
    };

    MyCustomDirectLoadStrategy.prototype = new jsGrid.loadStrategies.DirectLoadingStrategy();

    MyCustomDirectLoadStrategy.prototype.finishInsert = function (insertedItem) {
        console.log(insertedItem);
        var grid = this._grid;
        grid.option("data").unshift(insertedItem);
        grid.refresh();
        var $row = $("#jsGrid").jsGrid("rowByItem", insertedItem);
        console.log($row);
        $row.addClass("jsgrid-new-item");
        $row.children('.jsgrid-cell').css('background-color', '#fce38a');
    };

    var origFinishDelete = jsGrid.loadStrategies.DirectLoadingStrategy.prototype.finishDelete;

    MyCustomDirectLoadStrategy.prototype.finishDelete = function (deletedItem, deletedItemIndex) {
        if(this._grid.deletionFailed) { // define deletionFailed on done of delete ajax request in deleteItem of controller
            alert("Такого элемента уже не существует");
            return;
        }
        origFinishDelete.apply(this, arguments);
        webSocket.send("StatusChanged");
    };

    //Параметры таблицы

    $(function () {

        $("#jsGrid").jsGrid({
            width: "100%",

            filtering: false,
            editing: false,
            sorting: true,
            paging: false,
            inserting: false,
            autoload: true,


            loadStrategy: function () {
                return new MyCustomDirectLoadStrategy(this);
            },

            onDataLoaded: function (args) {
                {% if type == "current" %}
                    subscribe();
                    setInterval("subscribe()", 10000);
                {% endif %}
            },

            controller: {
                loadData: function (filter) {

                    //Получение сведений о текущей дате и фильтрация

                    var date = new Date();
                    var dateStr = moment(date).format('YYYY-MM-DD HH:mm:ss');

                    {% if type == "current" %}
                        var url = "/api/orders/?format=json&date_gte=" + dateStr;
                    {% else %}
                        var url = "/api/orders/?format=json&date_lte=" + dateStr;
                    {% endif %}

                    var d = $.Deferred();
                    $.ajax({
                        type: "GET",
                        url: url
                    }).done(function (result) {
                        if (result[0] !== undefined) {
                            latest_id = result[0].pk;
                        }
                        d.resolve($.map(result, function (item) {
                            var seance = item.seance.start_time;
                            if (item.seance.end_time !== null) {
                                seance += " - ";
                                seance += item.seance.end_time
                            }
                            return $.extend(item, {museum: item.museum.name, date: item.seance.date, seance: seance, company: item.seance.company_id});
                        }));
                    });
                    return d.promise();
                },

                deleteItem: function (item) {
                    return $.ajax({
                        type: "DELETE",
                        url: "/orders/delete/" + item.pk,
                        success: function (result) {
                            if (item.pk === latest_id) {
                                latest_id = result.latest_id
                            }
                        }
                    });
                }
            },

            fields: [
                {name: "pk", title: "ID", type: "text", align: "center", width: 30, editing: false},
                {name: "name", title: "Имя", type: "text", align: "center", width: 100, editing: false},
                {name: "phone", title: "Телефон", type: "text", align: "center", width: 100, editing: false},
                {name: "email", title: "Email", type: "text", align: "center", width: 100, editing: false},
                {name: "date", title: "Дата экскурсии", type: "text", align: "center", width: 100, editing: false},
                {name: "company", title: "Компания", type: "text", align: "center", width: 100, editing: false,
                itemTemplate: function (value, item) {
                    return value;
                }},
                {name: "museum", title: "Музей", type: "text", align: "center", width: 100, editing: false},
                {name: "seance", title: "Время", type: "text", align: "center", width: 75, editing: false},
                {
                    name: "fullticket_count",
                    title: "Кол-во взрослых",
                    type: "number",
                    align: "center",
                    width: 75,
                    editing: false
                },
                {
                    name: "reduceticket_count",
                    title: "Кол-во льготных",
                    type: "number",
                    align: "center",
                    width: 75,
                    editing: false
                },
                {
                    name: "audioguide",
                    title: "Аудиогид",
                    type: "text",
                    align: "center",
                    width: 50,
                    editing: false,
                    itemTemplate: function (value, item) {
                        var iconClass = "";
                        if (value === true) {
                            iconClass = "fa fa-check";
                        } else if (value === false) {
                            iconClass = "fa fa-times";
                        }
                        return $("<i>").attr("class", iconClass);
                    }
                },
                {
                    name: "accompanying_guide",
                    title: "Сопровождающий гид",
                    type: "text",
                    align: "center",
                    width: 80,
                    editing: false,
                    itemTemplate: function (value, item) {
                    var iconClass = "";
                    if (value === true) {
                        iconClass = "fa fa-check";
                    } else if (value === false) {
                        iconClass = "fa fa-times";
                    }
                    return $("<i>").attr("class", iconClass);
                }
                },
                {
                    name: "status", align: "center", title: "Статус", itemTemplate: function (value, item) {

                    //Создание select элемента содержащего статус заказа

                    var arr = [
                        {val: 1, text: 'Новый'},
                        {val: 2, text: 'Одобрен'},
                        {val: 3, text: 'Выкуплен'},
                        {val: 4, text: 'Отказан'}
                    ];
                    var sel = $('<select>');
                    $(arr).each(function () {
                        var sel_option = $("<option>").attr('value', this.val).text(this.text);
                        if (value === this.val) {
                            sel_option.attr('selected', 'true')
                        }
                        sel.append(sel_option);
                    });

                    return sel
                            .on("change", function () {
                                return $.ajax({
                                    type: "POST",
                                    data: {"new_status": this.value},
                                    url: "/orders/update_status/" + item.pk
                                }).then($("#jsGrid").jsGrid("render").done(function() {})).then(webSocket.send("StatusChanged"));
                            })
                    }
                },
                {name: "full_price", title: "Цена", type: "number", align: "center", width: 50, editing: false},
                {
                    type: "control", modeSwitchButton: false, editButton: false, editing: false,
                    itemTemplate: function (value, item) {
                        var $result = jsGrid.fields.control.prototype.itemTemplate.apply(this, arguments);
                        var $a = $("<a>").attr("href", "/orders/edit/" + item.pk).addClass("jsgrid-button").addClass("jsgrid-edit-button");
                        var $customButton = $("<input>").addClass("jsgrid-button").addClass("jsgrid-edit-button").attr({type: "button"});
                        $a.append($customButton);
                        return $result.add($a);
                    }
                }
            ],

            rowClass: function(item, itemIndex) {
                switch (item.status) {
                    case 1:
                        return "jsgrid-new-item";
                    case 2:
                        return "jsgrid-approved-item";
                    case 3:
                        return "jsgrid-purchased-item";
                    case 4:
                        return "jsgrid-denied-item";
                    default:
                        return "jsgrid-default-item";
                }
            }
        });
    });
</script>




